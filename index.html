<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RES ‚Äì Roblox Economy Revival</title>

  <!-- Three.js as ES module (kept for future 3D avatar use) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    window.THREE = THREE;
  </script>

  <style>
    :root {
      --bg: #e3e6ea;
      --bg-card: #ffffff;
      --bg-card-soft: #f5f6f8;
      --border-soft: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #00a2ff;
      --accent-soft: #e3f2fd;
      --shadow-soft: 0 2px 6px rgba(0,0,0,0.08);
      --nav-bg: #f8fafc;
      --nav-border: #d1d5db;
      --nav-text: #111827;
      --search-bg: #e5e7eb;
      --notif-bg: #f97316;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #facc15;
    }
    body.dark {
      --bg: #111827;
      --bg-card: #1f2933;
      --bg-card-soft: #111827;
      --border-soft: #374151;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #3b82f6;
      --accent-soft: #1d4ed8;
      --shadow-soft: 0 2px 10px rgba(0,0,0,0.6);
      --nav-bg: #111827;
      --nav-border: #1f2933;
      --nav-text: #e5e7eb;
      --search-bg: #1f2933;
      --notif-bg: #f97316;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Roboto", "Arial", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      transition: background 0.2s, color 0.2s;
    }

    .top-bar {
      background: var(--nav-bg);
      border-bottom: 1px solid var(--nav-border);
      padding: 6px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-box {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      background: #00a2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      margin-right: 4px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 900;
      color: var(--nav-text);
      letter-spacing: 0.5px;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 10px;
    }

    .nav-links a {
      color: var(--nav-text);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
    }

    .nav-links a:hover {
      background: var(--bg-card-soft);
      color: var(--accent);
    }

    .top-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: var(--search-bg);
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      max-width: 360px;
      width: 100%;
    }

    .search-box input {
      border: none;
      background: transparent;
      outline: none;
      flex: 1;
      font-size: 13px;
      color: var(--text-main);
    }

    .search-icon {
      font-size: 14px;
      color: var(--text-muted);
      margin-right: 6px;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .nav-username {
      font-weight: 500;
      color: var(--text-main);
    }

    .nav-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .nav-btn:hover {
      filter: brightness(0.9);
    }

    .notif-bell {
      position: relative;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
    }

    .notif-bell:hover {
      background: var(--bg-card-soft);
    }

    .notif-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--notif-bg);
      color: #fff;
      border-radius: 999px;
      padding: 1px 5px;
      font-size: 10px;
      font-weight: 700;
    }

    .verified-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #2563eb;
      color: #fff;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 999px;
      margin-left: 4px;
      border: 1px solid #93c5fd;
    }

    .verified-badge::before {
      content: "‚úî";
      font-size: 9px;
      margin-right: 2px;
    }

    .container {
      max-width: 1200px;
      margin: 16px auto 40px;
      display: flex;
      gap: 16px;
      padding: 0 12px;
    }

    .column-left {
      width: 260px;
      flex-shrink: 0;
    }

    .column-main {
      flex: 1;
    }

    .column-right {
      width: 260px;
      flex-shrink: 0;
    }

    .panel {
      background: var(--bg-card);
      border-radius: 6px;
      padding: 14px 16px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
      border: 1px solid var(--border-soft);
    }

    .panel h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: var(--accent);
      border-bottom: 1px solid var(--border-soft);
      padding-bottom: 6px;
    }

    .panel h3 {
      margin: 8px 0 6px 0;
      font-size: 15px;
      color: var(--text-main);
    }

    .btn {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      padding: 7px 12px;
      font-size: 13px;
      text-decoration: none;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn.small {
      padding: 4px 8px;
      font-size: 12px;
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn.secondary {
      background: #6b7280;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .input, .select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid var(--border-soft);
      font-size: 13px;
      background: var(--bg-card-soft);
      color: var(--text-main);
      outline: none;
    }

    .input:focus, .select:focus {
      border-color: var(--accent);
    }

    .muted {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-soft);
      margin-right: 4px;
    }

    .pill.green {
      border-color: #22c55e;
      color: #16a34a;
      background: #dcfce7;
    }

    .pill.red {
      border-color: #ef4444;
      color: #b91c1c;
      background: #fee2e2;
    }

    .pill.yellow {
      border-color: #facc15;
      color: #ca8a04;
      background: #fef9c3;
    }

    .error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }

    .success {
      color: var(--success);
      font-size: 12px;
      margin-top: 4px;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .flex-row {
      display: flex;
      gap: 10px;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .avatar-box {
      width: 100%;
      height: 180px;
      border-radius: 6px;
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 32px;
    }

    .catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }

    .item-card {
      background: var(--bg-card-soft);
      border-radius: 6px;
      padding: 8px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .item-thumb {
      width: 100%;
      height: 90px;
      border-radius: 4px;
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 4px;
    }

    .item-name {
      font-size: 13px;
      font-weight: 600;
    }

    .item-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .tag-limited {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 999px;
      background: #f97316;
      color: #fff;
      margin-left: 4px;
    }

    .trade-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .trade-column {
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      padding: 8px;
      background: var(--bg-card-soft);
    }

    .trade-items-list {
      max-height: 160px;
      overflow-y: auto;
      border-radius: 4px;
      border: 1px solid var(--border-soft);
      padding: 4px;
      background: var(--bg-card);
      font-size: 12px;
    }

    .trade-item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .trade-item-row:last-child {
      border-bottom: none;
    }

    .trade-bux-section {
      margin-top: 6px;
    }

    .fairness-meter {
      width: 100%;
      height: 10px;
      background: #ddd;
      border-radius: 6px;
      margin-top: 8px;
      overflow: hidden;
    }

    .fairness-fill {
      height: 100%;
      width: 0%;
      background: #4ade80;
      transition: width 0.3s, background 0.3s;
    }

    .fairness-label {
      margin-top: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .trade-summary {
      margin-top: 8px;
      font-size: 12px;
    }

    .trade-summary span {
      display: inline-block;
      margin-right: 8px;
    }

    .trade-list-entry {
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      padding: 8px;
      margin-bottom: 6px;
      background: var(--bg-card-soft);
      font-size: 12px;
    }

    .trade-list-entry-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .badge-incoming {
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: 10px;
      font-weight: 600;
    }

    .badge-outgoing {
      background: #fef3c7;
      color: #92400e;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: 10px;
      font-weight: 600;
    }

    .chat-box {
      height: 200px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      padding: 6px;
      background: var(--bg-card-soft);
      overflow-y: auto;
      font-size: 12px;
    }

    .chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .notif-list {
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }

    .notif-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .notif-entry:last-child {
      border-bottom: none;
    }

    .confirm-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <div class="logo-box">R</div>
      <div class="logo-text">RES</div>
      <div class="nav-links">
        <a data-view="homeView">Home</a>
        <a data-view="catalogView">Catalog</a>
        <a data-view="createView">Create</a>
        <a data-view="profileView">Profile</a>
        <a data-view="tradeView">Trades</a>
        <a data-view="adminView" id="adminNavLink" class="hidden">Admin</a>
      </div>
    </div>
    <div class="top-center">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input id="globalSearchInput" placeholder="Search users or items...">
      </div>
    </div>
    <div class="top-right">
      <span id="navUserLabel" class="nav-username">Guest</span>
      <span id="navCurrencyLabel" class="muted">0 RES</span>
      <div class="notif-bell" id="notifBell">
        üîî
        <span id="notifCount" class="notif-count hidden">0</span>
      </div>
      <button id="themeToggleBtn" class="nav-btn secondary">Theme</button>
      <button id="authBtn" class="nav-btn">Login / Signup</button>
    </div>
  </div>

  <div class="container">
    <div class="column-left">
      <div class="panel" id="authPanel">
        <h2>Account</h2>
        <div id="authLoggedOut">
          <label class="label">Username</label>
          <input id="authUsername" class="input" placeholder="Enter username">
          <label class="label">Password</label>
          <input id="authPassword" class="input" type="password" placeholder="Enter password">
          <button id="loginBtn" class="btn" style="margin-top:6px;">Login</button>
          <button id="signupBtn" class="btn secondary" style="margin-top:4px;">Signup</button>
          <div id="authMessage" class="muted" style="margin-top:4px;"></div>
        </div>
        <div id="authLoggedIn" class="hidden">
          <div class="muted">Logged in as</div>
          <div id="authCurrentUser" style="font-weight:600;margin-bottom:6px;"></div>
          <div class="muted">RES Bux:</div>
          <div id="authCurrentCurrency" style="font-weight:600;margin-bottom:6px;"></div>
          <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>
      </div>

      <div class="panel">
        <h2>Stats</h2>
        <div class="muted">Total Users: <span id="statTotalUsers">0</span></div>
        <div class="muted">Total Items: <span id="statTotalItems">0</span></div>
        <div class="muted">Total Trades: <span id="statTotalTrades">0</span></div>
        <div class="muted">Total RES in circulation: <span id="statTotalRes">0</span></div>
      </div>

      <div class="panel">
        <h2>Friends</h2>
        <div id="friendsList" class="muted">Login to see friends.</div>
      </div>
    </div>

    <div class="column-main">
      <!-- Home -->
      <div id="homeView" class="view active">
        <div class="panel">
          <h2>Home</h2>
          <div class="flex-row">
            <div style="flex:1;">
              <h3>Welcome</h3>
              <div class="muted" id="homeWelcomeText">
                Login or signup to start trading, creating, and collecting.
              </div>
              <div style="margin-top:8px;">
                <span class="pill">Classic Economy</span>
                <span class="pill">Trading</span>
                <span class="pill">Limiteds</span>
              </div>
            </div>
            <div style="width:220px;">
              <div class="avatar-box" id="homeAvatarBox">R6</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>Feed</h2>
          <div id="homeFeed" class="muted">No activity yet.</div>
        </div>
      </div>

      <!-- Catalog -->
      <div id="catalogView" class="view">
        <div class="panel">
          <h2>Catalog</h2>
          <div class="flex-row" style="margin-bottom:8px;">
            <div style="flex:1;">
              <label class="label">Sort</label>
              <select id="catalogSort" class="select">
                <option value="default">Default</option>
                <option value="priceLow">Price: Low ‚Üí High</option>
                <option value="priceHigh">Price: High ‚Üí Low</option>
                <option value="valueHigh">Value: High ‚Üí Low</option>
              </select>
            </div>
            <div style="flex:1;">
              <label class="label">Filter</label>
              <select id="catalogFilter" class="select">
                <option value="all">All</option>
                <option value="limited">Limited</option>
                <option value="clothing">Clothing</option>
              </select>
            </div>
          </div>
          <div id="catalogGrid" class="catalog-grid"></div>
        </div>
      </div>

      <!-- Create -->
      <div id="createView" class="view">
        <div class="panel">
          <h2>Create Item</h2>
          <div id="createGuestLock" class="muted">Login to create items.</div>
          <div id="createForm" class="hidden">
            <label class="label">Name</label>
            <input id="createName" class="input" placeholder="Cool Fedora">
            <label class="label">Type</label>
            <select id="createType" class="select">
              <option value="clothing">Clothing</option>
              <option value="limited">Limited</option>
            </select>
            <label class="label">Price (RES)</label>
            <input id="createPrice" class="input" type="number" min="0" value="100">
            <label class="label">Base Value</label>
            <input id="createValue" class="input" type="number" min="0" value="100">
            <button id="createItemBtn" class="btn" style="margin-top:8px;">Create</button>
            <div id="createMessage" class="muted" style="margin-top:4px;"></div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div id="profileView" class="view">
        <div class="panel">
          <h2>Profile</h2>
          <div id="profileGuestLock" class="muted">Login to view your profile.</div>
          <div id="profileContent" class="hidden">
            <div class="flex-row">
              <div style="width:220px;">
                <div class="avatar-box" id="profileAvatarBox">R6</div>
              </div>
              <div style="flex:1;">
                <h3 id="profileUsername"></h3>
                <div class="muted">RES Bux: <span id="profileCurrency"></span></div>
                <div class="muted">Total Inventory Value: <span id="profileTotalValue"></span></div>
                <div style="margin-top:6px;">
                  <span class="pill" id="profileFriendsCount">0 Friends</span>
                  <span class="pill" id="profileTradesCount">0 Trades</span>
                </div>
              </div>
            </div>

            <h3 style="margin-top:12px;">Inventory</h3>
            <div class="flex-row" style="margin-bottom:6px;">
              <div style="flex:1;">
                <label class="label">Filter</label>
                <select id="inventoryFilter" class="select">
                  <option value="all">All</option>
                  <option value="limited">Limited</option>
                  <option value="clothing">Clothing</option>
                </select>
              </div>
            </div>
            <div id="profileInventory" class="catalog-grid"></div>
          </div>
        </div>
      </div>

      <!-- Trades -->
      <div id="tradeView" class="view">
        <div class="panel">
          <h2>Trades</h2>
          <div id="tradeGuestLock" class="muted">Login to trade.</div>
          <div id="tradeContent" class="hidden">
            <h3>Create Trade</h3>
            <div class="flex-row" style="margin-bottom:6px;">
              <div style="flex:1;">
                <label class="label">Trade with user</label>
                <input id="tradeTargetUser" class="input" placeholder="username">
              </div>
              <div style="width:140px;">
                <label class="label">&nbsp;</label>
                <button id="openTradeWindowBtn" class="btn small" style="width:100%;">Open Trade Window</button>
              </div>
            </div>
            <div id="tradeMessage" class="muted" style="margin-bottom:8px;"></div>

            <div id="tradeWindow" class="hidden">
              <div class="trade-columns">
                <div class="trade-column">
                  <div class="flex-between">
                    <strong>Your Offer</strong>
                    <span class="muted" id="tradeOfferUserLabel"></span>
                  </div>
                  <label class="label" style="margin-top:4px;">Add Item</label>
                  <select id="tradeOfferAddSelect" class="select"></select>
                  <button id="tradeOfferAddBtn" class="btn small" style="margin-top:4px;">Add</button>

                  <div class="trade-bux-section">
                    <label class="label">Add RES Bux</label>
                    <input id="tradeOfferBuxInput" class="input" type="number" min="0" value="0">
                  </div>

                  <div class="trade-items-list" id="tradeOfferItems" style="margin-top:6px;"></div>
                </div>

                <div class="trade-column">
                  <div class="flex-between">
                    <strong>Your Request</strong>
                    <span class="muted" id="tradeRequestUserLabel"></span>
                  </div>
                  <label class="label" style="margin-top:4px;">Request Item</label>
                  <select id="tradeRequestAddSelect" class="select"></select>
                  <button id="tradeRequestAddBtn" class="btn small" style="margin-top:4px;">Add</button>

                  <div class="trade-bux-section">
                    <label class="label">Add RES Bux</label>
                    <input id="tradeRequestBuxInput" class="input" type="number" min="0" value="0">
                  </div>

                  <div class="trade-items-list" id="tradeRequestItems" style="margin-top:6px;"></div>
                </div>
              </div>

              <div class="trade-summary">
                <span id="tradeOfferTotalLabel"></span>
                <span id="tradeRequestTotalLabel"></span>
                <span id="tradeDiffLabel"></span>
              </div>

              <div class="fairness-meter">
                <div id="tradeFairnessFill" class="fairness-fill"></div>
              </div>
              <div id="tradeFairnessLabel" class="fairness-label"></div>

              <div class="flex-between" style="margin-top:8px;">
                <button id="createTradeBtn" class="btn">Send Trade</button>
                <button id="closeTradeWindowBtn" class="btn secondary">Close</button>
              </div>
            </div>

            <h3 style="margin-top:14px;">Your Trades</h3>
            <div id="tradeListIncomingHeader" class="muted" style="margin-top:4px;">Incoming</div>
            <div id="tradeListIncoming"></div>
            <div id="tradeListOutgoingHeader" class="muted" style="margin-top:8px;">Outgoing</div>
            <div id="tradeListOutgoing"></div>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div id="adminView" class="view">
        <div class="panel">
          <h2>Admin</h2>
          <div id="adminGuestLock" class="muted">Admin only.</div>
          <div id="adminContent" class="hidden">
            <h3>Give RES</h3>
            <label class="label">User</label>
            <input id="adminGiveUser" class="input" placeholder="username">
            <label class="label">Amount</label>
            <input id="adminGiveAmount" class="input" type="number" value="1000">
            <button id="adminGiveBtn" class="btn" style="margin-top:6px;">Give RES</button>

            <h3 style="margin-top:12px;">Delete Item</h3>
            <label class="label">Item ID</label>
            <input id="adminDeleteItemId" class="input" placeholder="1">
            <button id="adminDeleteItemBtn" class="btn danger" style="margin-top:6px;">Delete Item</button>
            <div class="confirm-text">This cannot be undone.</div>

            <div id="adminMessage" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="column-right">
      <div class="panel">
        <h2>Chat</h2>
        <div id="chatBox" class="chat-box"></div>
        <div class="chat-input-row">
          <input id="chatInput" class="input" placeholder="Say something...">
          <button id="chatSendBtn" class="btn small">Send</button>
        </div>
      </div>

      <div class="panel">
        <h2>Notifications</h2>
        <div id="notifList" class="notif-list"></div>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_USERNAME = "roblox owner admin";

    let db = {
      users: {},
      items: {},
      trades: [],
      chat: [],
      notifications: [],
      nextItemId: 1,
      currentUser: null
    };

    function loadData() {
      try {
        const raw = localStorage.getItem("res_db_v1");
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          db = Object.assign(db, parsed);
        }
      } catch (e) {
        console.error("loadData error", e);
      }
    }

    function saveData() {
      try {
        localStorage.setItem("res_db_v1", JSON.stringify(db));
      } catch (e) {
        console.error("saveData error", e);
      }
    }

    function getCurrentUser() {
      if (!db.currentUser) return null;
      return db.users[db.currentUser] || null;
    }

    function ensureDemoData() {
      if (Object.keys(db.users).length === 0) {
        db.users["roblox owner admin"] = {
          username: "roblox owner admin",
          password: "admin",
          currency: 1000000,
          inventory: [],
          friends: [],
          createdAt: Date.now()
        };
        db.currentUser = "roblox owner admin";
      }
      if (Object.keys(db.items).length === 0) {
        const baseItems = [
          { name: "Classic Fedora", type: "limited", price: 1000, value: 1000 },
          { name: "Blue Top Hat", type: "limited", price: 800, value: 800 },
          { name: "Red Shirt", type: "clothing", price: 25, value: 25 },
          { name: "Black Pants", type: "clothing", price: 25, value: 25 }
        ];
        baseItems.forEach(it => {
          const id = db.nextItemId++;
          db.items[id] = {
            id,
            name: it.name,
            type: it.type,
            price: it.price,
            value: it.value,
            creator: "roblox owner admin"
          };
        });
      }
    }

    function itemInitials(name) {
      if (!name) return "?";
      const parts = name.split(" ");
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
    }

    function rarityBadgeClass(item) {
      if (!item || item.type !== "limited") return "";
      if (item.value >= 2000) return "pill red";
      if (item.value >= 1000) return "pill yellow";
      return "pill green";
    }

    function formatRes(n) {
      return (n || 0).toLocaleString() + " RES";
    }

    function addNotification(text) {
      db.notifications.unshift({
        id: Date.now() + Math.random(),
        text,
        createdAt: Date.now()
      });
      if (db.notifications.length > 50) db.notifications.pop();
      saveData();
      renderNotifications();
    }

    function addChatMessage(from, text) {
      db.chat.push({
        id: Date.now() + Math.random(),
        from,
        text,
        createdAt: Date.now()
      });
      if (db.chat.length > 100) db.chat.shift();
      saveData();
      renderChat();
    }

    const views = {
      homeView: document.getElementById("homeView"),
      catalogView: document.getElementById("catalogView"),
      createView: document.getElementById("createView"),
      profileView: document.getElementById("profileView"),
      tradeView: document.getElementById("tradeView"),
      adminView: document.getElementById("adminView")
    };

    function showView(id) {
      Object.values(views).forEach(v => v.classList.remove("active"));
      if (views[id]) views[id].classList.add("active");
    }

    const navLinks = document.querySelectorAll(".nav-links a");
    navLinks.forEach(a => {
      a.addEventListener("click", () => {
        const v = a.getAttribute("data-view");
        if (!v) return;
        showView(v);
        renderAll();
      });
    });

    const navUserLabel = document.getElementById("navUserLabel");
    const navCurrencyLabel = document.getElementById("navCurrencyLabel");
    const authBtn = document.getElementById("authBtn");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const notifBell = document.getElementById("notifBell");
    const notifCount = document.getElementById("notifCount");
    const adminNavLink = document.getElementById("adminNavLink");

    const authLoggedOut = document.getElementById("authLoggedOut");
    const authLoggedIn = document.getElementById("authLoggedIn");
    const authUsername = document.getElementById("authUsername");
    const authPassword = document.getElementById("authPassword");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const authMessage = document.getElementById("authMessage");
    const authCurrentUser = document.getElementById("authCurrentUser");
    const authCurrentCurrency = document.getElementById("authCurrentCurrency");
    const logoutBtn = document.getElementById("logoutBtn");

    const statTotalUsers = document.getElementById("statTotalUsers");
    const statTotalItems = document.getElementById("statTotalItems");
    const statTotalTrades = document.getElementById("statTotalTrades");
    const statTotalRes = document.getElementById("statTotalRes");

    const friendsList = document.getElementById("friendsList");

    const homeWelcomeText = document.getElementById("homeWelcomeText");
    const homeAvatarBox = document.getElementById("homeAvatarBox");
    const homeFeed = document.getElementById("homeFeed");

    const catalogGrid = document.getElementById("catalogGrid");
    const catalogSort = document.getElementById("catalogSort");
    const catalogFilter = document.getElementById("catalogFilter");

    const createGuestLock = document.getElementById("createGuestLock");
    const createForm = document.getElementById("createForm");
    const createName = document.getElementById("createName");
    const createType = document.getElementById("createType");
    const createPrice = document.getElementById("createPrice");
    const createValue = document.getElementById("createValue");
    const createItemBtn = document.getElementById("createItemBtn");
    const createMessage = document.getElementById("createMessage");

    const profileGuestLock = document.getElementById("profileGuestLock");
    const profileContent = document.getElementById("profileContent");
    const profileAvatarBox = document.getElementById("profileAvatarBox");
    const profileUsername = document.getElementById("profileUsername");
    const profileCurrency = document.getElementById("profileCurrency");
    const profileTotalValue = document.getElementById("profileTotalValue");
    const profileFriendsCount = document.getElementById("profileFriendsCount");
    const profileTradesCount = document.getElementById("profileTradesCount");
    const profileInventory = document.getElementById("profileInventory");
    const inventoryFilter = document.getElementById("inventoryFilter");

    const tradeGuestLock = document.getElementById("tradeGuestLock");
    const tradeContent = document.getElementById("tradeContent");
    const tradeTargetUser = document.getElementById("tradeTargetUser");
    const openTradeWindowBtn = document.getElementById("openTradeWindowBtn");
    const tradeMessage = document.getElementById("tradeMessage");
    const tradeWindow = document.getElementById("tradeWindow");
    const tradeOfferUserLabel = document.getElementById("tradeOfferUserLabel");
    const tradeRequestUserLabel = document.getElementById("tradeRequestUserLabel");
    const tradeOfferAddSelect = document.getElementById("tradeOfferAddSelect");
    const tradeRequestAddSelect = document.getElementById("tradeRequestAddSelect");
    const tradeOfferAddBtn = document.getElementById("tradeOfferAddBtn");
    const tradeRequestAddBtn = document.getElementById("tradeRequestAddBtn");
    const tradeOfferItems = document.getElementById("tradeOfferItems");
    const tradeRequestItems = document.getElementById("tradeRequestItems");
    const tradeOfferBuxInput = document.getElementById("tradeOfferBuxInput");
    const tradeRequestBuxInput = document.getElementById("tradeRequestBuxInput");
    const tradeOfferTotalLabel = document.getElementById("tradeOfferTotalLabel");
    const tradeRequestTotalLabel = document.getElementById("tradeRequestTotalLabel");
    const tradeDiffLabel = document.getElementById("tradeDiffLabel");
    const tradeFairnessFill = document.getElementById("tradeFairnessFill");
    const tradeFairnessLabel = document.getElementById("tradeFairnessLabel");
    const createTradeBtn = document.getElementById("createTradeBtn");
    const closeTradeWindowBtn = document.getElementById("closeTradeWindowBtn");
    const tradeListIncoming = document.getElementById("tradeListIncoming");
    const tradeListOutgoing = document.getElementById("tradeListOutgoing");

    const adminGuestLock = document.getElementById("adminGuestLock");
    const adminContent = document.getElementById("adminContent");
    const adminGiveUser = document.getElementById("adminGiveUser");
    const adminGiveAmount = document.getElementById("adminGiveAmount");
    const adminGiveBtn = document.getElementById("adminGiveBtn");
    const adminDeleteItemId = document.getElementById("adminDeleteItemId");
    const adminDeleteItemBtn = document.getElementById("adminDeleteItemBtn");
    const adminMessage = document.getElementById("adminMessage");

    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");

    const notifList = document.getElementById("notifList");

    const globalSearchInput = document.getElementById("globalSearchInput");

    let currentOfferIds = [];
    let currentRequestIds = [];
    let currentTradeTarget = null;

    function renderAuth() {
      const user = getCurrentUser();
      if (!user) {
        authLoggedOut.classList.remove("hidden");
        authLoggedIn.classList.add("hidden");
        navUserLabel.textContent = "Guest";
        navCurrencyLabel.textContent = "0 RES";
        authBtn.textContent = "Login / Signup";
        adminNavLink.classList.add("hidden");
      } else {
        authLoggedOut.classList.add("hidden");
        authLoggedIn.classList.remove("hidden");
        authCurrentUser.textContent = user.username;
        authCurrentCurrency.textContent = formatRes(user.currency);
        navUserLabel.textContent = user.username;
        navCurrencyLabel.textContent = formatRes(user.currency);
        authBtn.textContent = "Account";
        if (user.username === ADMIN_USERNAME) {
          adminNavLink.classList.remove("hidden");
        } else {
          adminNavLink.classList.add("hidden");
        }
      }
    }

    function renderStats() {
      statTotalUsers.textContent = Object.keys(db.users).length;
      statTotalItems.textContent = Object.keys(db.items).length;
      statTotalTrades.textContent = db.trades.length;
      let totalRes = 0;
      Object.values(db.users).forEach(u => totalRes += (u.currency || 0));
      statTotalRes.textContent = formatRes(totalRes);
    }

    function renderFriends() {
      const user = getCurrentUser();
      if (!user) {
        friendsList.textContent = "Login to see friends.";
        return;
      }
      const friends = (user.friends || []).slice().sort();
      if (friends.length === 0) {
        friendsList.textContent = "No friends yet.";
        return;
      }
      friendsList.innerHTML = "";
      friends.forEach(f => {
        const div = document.createElement("div");
        div.textContent = f;
        friendsList.appendChild(div);
      });
    }

    function renderHome() {
      const user = getCurrentUser();
      if (!user) {
        homeWelcomeText.textContent = "Login or signup to start trading, creating, and collecting.";
        homeAvatarBox.textContent = "R6";
      } else {
        homeWelcomeText.textContent = `Welcome back, ${user.username}. Start trading, creating, and flexing your inventory.`;
        homeAvatarBox.textContent = itemInitials(user.username);
      }
      if (db.trades.length === 0) {
        homeFeed.textContent = "No trade activity yet.";
      } else {
        const recent = db.trades.slice(-5).reverse();
        homeFeed.innerHTML = "";
        recent.forEach(t => {
          const from = t.from;
          const to = t.to;
          const div = document.createElement("div");
          div.className = "muted";
          div.textContent = `${from} traded with ${to} (${t.status})`;
          homeFeed.appendChild(div);
        });
      }
    }

    function renderCatalog() {
      let items = Object.values(db.items);
      const filter = catalogFilter.value;
      if (filter === "limited") items = items.filter(i => i.type === "limited");
      if (filter === "clothing") items = items.filter(i => i.type === "clothing");

      const sort = catalogSort.value;
      if (sort === "priceLow") items.sort((a,b)=>a.price-b.price);
      if (sort === "priceHigh") items.sort((a,b)=>b.price-a.price);
      if (sort === "valueHigh") items.sort((a,b)=>(b.value||0)-(a.value||0));

      catalogGrid.innerHTML = "";
      const user = getCurrentUser();

      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "item-card";

        const thumb = document.createElement("div");
        thumb.className = "item-thumb";
        thumb.textContent = itemInitials(item.name);
        card.appendChild(thumb);

        const nameRow = document.createElement("div");
        nameRow.className = "item-name";
        nameRow.textContent = item.name;
        if (item.type === "limited") {
          const tag = document.createElement("span");
          tag.className = "tag-limited";
          tag.textContent = "LIMITED";
          nameRow.appendChild(tag);
        }
        card.appendChild(nameRow);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        meta.textContent = `Price: ${formatRes(item.price)} ‚Ä¢ Value: ${item.value}`;
        card.appendChild(meta);

        const creator = document.createElement("div");
        creator.className = "muted";
        creator.textContent = `Creator: ${item.creator}`;
        card.appendChild(creator);

        const btnRow = document.createElement("div");
        btnRow.style.marginTop = "4px";

        const buyBtn = document.createElement("button");
        buyBtn.className = "btn small";
        buyBtn.textContent = "Buy";
        buyBtn.disabled = !user;
        buyBtn.addEventListener("click", () => {
          if (!user) return;
          if (user.currency < item.price) {
            addNotification("You do not have enough RES.");
            return;
          }
          user.currency -= item.price;
          user.inventory.push(item.id);
          saveData();
          addNotification(`You bought ${item.name} for ${formatRes(item.price)}.`);
          renderAll();
        });
        btnRow.appendChild(buyBtn);

        card.appendChild(btnRow);
        catalogGrid.appendChild(card);
      });
    }

    function renderCreate() {
      const user = getCurrentUser();
      if (!user) {
        createGuestLock.classList.remove("hidden");
        createForm.classList.add("hidden");
      } else {
        createGuestLock.classList.add("hidden");
        createForm.classList.remove("hidden");
      }
    }

    function renderProfile() {
      const user = getCurrentUser();
      if (!user) {
        profileGuestLock.classList.remove("hidden");
        profileContent.classList.add("hidden");
        return;
      }
      profileGuestLock.classList.add("hidden");
      profileContent.classList.remove("hidden");

      profileAvatarBox.textContent = itemInitials(user.username);
      profileUsername.textContent = user.username;
      profileCurrency.textContent = formatRes(user.currency);

      const invIds = user.inventory || [];
      let totalValue = 0;
      invIds.forEach(id => {
        const it = db.items[id];
        if (it) totalValue += (it.value || 0);
      });
      profileTotalValue.textContent = totalValue.toLocaleString();

      profileFriendsCount.textContent = `${(user.friends||[]).length} Friends`;
      const tradesCount = db.trades.filter(t => t.from === user.username || t.to === user.username).length;
      profileTradesCount.textContent = `${tradesCount} Trades`;

      const filter = inventoryFilter.value;
      profileInventory.innerHTML = "";
      invIds.forEach(id => {
        const it = db.items[id];
        if (!it) return;
        if (filter !== "all" && it.type !== filter) return;

        const card = document.createElement("div");
        card.className = "item-card";

        const thumb = document.createElement("div");
        thumb.className = "item-thumb";
        thumb.textContent = itemInitials(it.name);
        card.appendChild(thumb);

        const nameRow = document.createElement("div");
        nameRow.className = "item-name";
        nameRow.textContent = it.name;
        if (it.type === "limited") {
          const tag = document.createElement("span");
          tag.className = "tag-limited";
          tag.textContent = "LIMITED";
          nameRow.appendChild(tag);
        }
        card.appendChild(nameRow);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        meta.textContent = `Value: ${it.value}`;
        card.appendChild(meta);

        profileInventory.appendChild(card);
      });
    }

    function renderTradeWindowLists() {
      const user = getCurrentUser();
      if (!user || !currentTradeTarget) return;
      const target = db.users[currentTradeTarget];
      if (!target) return;

      tradeOfferUserLabel.textContent = user.username;
      tradeRequestUserLabel.textContent = target.username;

      tradeOfferItems.innerHTML = "";
      tradeRequestItems.innerHTML = "";

      const offerInv = user.inventory || [];
      const reqInv = target.inventory || [];

      const offerSelectOptions = offerInv.map(id => db.items[id]).filter(Boolean);
      const reqSelectOptions = reqInv.map(id => db.items[id]).filter(Boolean);

      tradeOfferAddSelect.innerHTML = "";
      offerSelectOptions.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = `${it.name} (${it.value})`;
        tradeOfferAddSelect.appendChild(opt);
      });

      tradeRequestAddSelect.innerHTML = "";
      reqSelectOptions.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = `${it.name} (${it.value})`;
        tradeRequestAddSelect.appendChild(opt);
      });

      currentOfferIds.forEach(id => {
        const it = db.items[id];
        if (!it) return;
        const row = document.createElement("div");
        row.className = "trade-item-row";
        const left = document.createElement("span");
        left.textContent = `${it.name} (${it.value})`;
        const btn = document.createElement("button");
        btn.className = "btn small secondary";
        btn.textContent = "Remove";
        btn.addEventListener("click", () => {
          currentOfferIds = currentOfferIds.filter(x => x !== id);
          renderTradeWindowLists();
        });
        row.appendChild(left);
        row.appendChild(btn);
        tradeOfferItems.appendChild(row);
      });

      currentRequestIds.forEach(id => {
        const it = db.items[id];
        if (!it) return;
        const row = document.createElement("div");
        row.className = "trade-item-row";
        const left = document.createElement("span");
        left.textContent = `${it.name} (${it.value})`;
        const btn = document.createElement("button");
        btn.className = "btn small secondary";
        btn.textContent = "Remove";
        btn.addEventListener("click", () => {
          currentRequestIds = currentRequestIds.filter(x => x !== id);
          renderTradeWindowLists();
        });
        row.appendChild(left);
        row.appendChild(btn);
        tradeRequestItems.appendChild(row);
      });

      const offerValItems = currentOfferIds.reduce((sum, id) => sum + (db.items[id]?.value || 0), 0);
      const requestValItems = currentRequestIds.reduce((sum, id) => sum + (db.items[id]?.value || 0), 0);

      const offerBux = parseInt(tradeOfferBuxInput.value, 10) || 0;
      const requestBux = parseInt(tradeRequestBuxInput.value, 10) || 0;

      const offerTotal = offerValItems + offerBux;
      const requestTotal = requestValItems + requestBux;

      const offerTotalDiv = document.createElement("div");
      offerTotalDiv.className = "muted";
      offerTotalDiv.textContent = `Total Offer Value: ${offerTotal} (Items ${offerValItems} + ${offerBux} RES)`;
      tradeOfferItems.appendChild(offerTotalDiv);

      const requestTotalDiv = document.createElement("div");
      requestTotalDiv.className = "muted";
      requestTotalDiv.textContent = `Total Request Value: ${requestTotal} (Items ${requestValItems} + ${requestBux} RES)`;
      tradeRequestItems.appendChild(requestTotalDiv);

      tradeOfferTotalLabel.textContent = `Offer: ${offerTotal}`;
      tradeRequestTotalLabel.textContent = `Request: ${requestTotal}`;

      const diff = offerTotal - requestTotal;
      const absDiff = Math.abs(diff);
      let fairness = 100 - Math.min(absDiff / 10, 100);
      fairness = Math.max(0, Math.min(100, fairness));

      let diffText = "";
      let diffClass = "";
      if (diff > 0) {
        diffText = `You are overpaying by ${absDiff} value.`;
        diffClass = "pill red";
      } else if (diff < 0) {
        diffText = `You are winning by ${absDiff} value.`;
        diffClass = "pill green";
      } else {
        diffText = "Perfectly even trade.";
        diffClass = "pill";
      }
      tradeDiffLabel.innerHTML = `<span class="${diffClass}">${diffText}</span>`;

      tradeFairnessFill.style.width = fairness + "%";
      if (fairness > 70) {
        tradeFairnessFill.style.background = "#4ade80";
        tradeFairnessLabel.textContent = "Fair";
      } else if (fairness > 40) {
        tradeFairnessFill.style.background = "#facc15";
        tradeFairnessLabel.textContent = "Slightly Unfair";
      } else {
        tradeFairnessFill.style.background = "#ef4444";
        tradeFairnessLabel.textContent = "Very Unfair";
      }
    }

    function renderTrades() {
      const user = getCurrentUser();
      if (!user) {
        tradeGuestLock.classList.remove("hidden");
        tradeContent.classList.add("hidden");
        return;
      }
      tradeGuestLock.classList.add("hidden");
      tradeContent.classList.remove("hidden");

      const incoming = db.trades.filter(t => t.to === user.username).slice().sort((a,b)=>b.createdAt-a.createdAt);
      const outgoing = db.trades.filter(t => t.from === user.username).slice().sort((a,b)=>b.createdAt-a.createdAt);

      tradeListIncoming.innerHTML = "";
      tradeListOutgoing.innerHTML = "";

      function renderTradeEntry(t, isIncoming) {
        const fromUser = db.users[t.from];
        const toUser = db.users[t.to];

        const offerValItems = (t.offerItemIds || []).reduce((sum, id) => sum + (db.items[id]?.value || 0), 0);
        const requestValItems = (t.requestItemIds || []).reduce((sum, id) => sum + (db.items[id]?.value || 0), 0);
        const offerTotal = offerValItems + (t.offerBux || 0);
        const requestTotal = requestValItems + (t.requestBux || 0);
        const diff = offerTotal - requestTotal;
        const absDiff = Math.abs(diff);

        const entry = document.createElement("div");
        entry.className = "trade-list-entry";

        const header = document.createElement("div");
        header.className = "trade-list-entry-header";
        const left = document.createElement("div");
        left.textContent = `${t.from} ‚Üí ${t.to}`;
        const right = document.createElement("div");
        const badge = document.createElement("span");
        badge.className = isIncoming ? "badge-incoming" : "badge-outgoing";
        badge.textContent = isIncoming ? "Incoming" : "Outgoing";
        right.appendChild(badge);
        header.appendChild(left);
        header.appendChild(right);
        entry.appendChild(header);

        const offerNames = (t.offerItemIds || []).map(id => db.items[id]?.name).filter(Boolean).join(", ");
        const requestNames = (t.requestItemIds || []).map(id => db.items[id]?.name).filter(Boolean).join(", ");

        const offerBuxText = t.offerBux ? ` + ${t.offerBux} RES` : "";
        const requestBuxText = t.requestBux ? ` + ${t.requestBux} RES` : "";

        const body = document.createElement("div");
        body.innerHTML = `
          <div>Offers: ${offerNames || "None"} (Total ${offerTotal})${offerBuxText}</div>
          <div>Requests: ${requestNames || "None"} (Total ${requestTotal})${requestBuxText}</div>
        `;
        entry.appendChild(body);

        const diffSpan = document.createElement("div");
        diffSpan.style.marginTop = "4px";
        let diffText = "";
        let diffClass = "pill";
        if (diff > 0) {
          diffText = `${t.from} overpays by ${absDiff}`;
          diffClass = "pill red";
        } else if (diff < 0) {
          diffText = `${t.to} overpays by ${absDiff}`;
          diffClass = "pill green";
        } else {
          diffText = "Even trade";
        }
        diffSpan.innerHTML = `<span class="${diffClass}">${diffText}</span>`;
        entry.appendChild(diffSpan);

        const footer = document.createElement("div");
        footer.style.marginTop = "4px";
        const statusSpan = document.createElement("span");
        statusSpan.className = "muted";
        statusSpan.textContent = `Status: ${t.status}`;
        footer.appendChild(statusSpan);

        if (isIncoming && t.status === "pending") {
          const acceptBtn = document.createElement("button");
          acceptBtn.className = "btn small";
          acceptBtn.style.marginLeft = "6px";
          acceptBtn.textContent = "Accept";
          acceptBtn.addEventListener("click", () => {
            const from = db.users[t.from];
            const to = db.users[t.to];
            if (!from || !to) return;

            const hasAll = (t.offerItemIds || []).every(id => from.inventory.includes(id)) &&
                           (t.requestItemIds || []).every(id => to.inventory.includes(id));
            if (!hasAll) {
              addNotification("Trade failed: one user no longer owns an item.");
              t.status = "failed";
              saveData();
              renderAll();
              return;
            }

            (t.offerItemIds || []).forEach(id => {
              from.inventory = from.inventory.filter(x => x !== id);
              to.inventory.push(id);
            });
            (t.requestItemIds || []).forEach(id => {
              to.inventory = to.inventory.filter(x => x !== id);
              from.inventory.push(id);
            });

            from.currency -= (t.offerBux || 0);
            to.currency += (t.offerBux || 0);
            to.currency -= (t.requestBux || 0);
            from.currency += (t.requestBux || 0);

            t.status = "accepted";
            saveData();
            addNotification(`${t.to} accepted trade from ${t.from}.`);
            renderAll();
          });
          footer.appendChild(acceptBtn);

          const declineBtn = document.createElement("button");
          declineBtn.className = "btn small secondary";
          declineBtn.style.marginLeft = "4px";
          declineBtn.textContent = "Decline";
          declineBtn.addEventListener("click", () => {
            t.status = "declined";
            saveData();
            renderAll();
          });
          footer.appendChild(declineBtn);
        }

        entry.appendChild(footer);
        return entry;
      }

      incoming.forEach(t => {
        tradeListIncoming.appendChild(renderTradeEntry(t, true));
      });
      outgoing.forEach(t => {
        tradeListOutgoing.appendChild(renderTradeEntry(t, false));
      });
    }

    function renderAdmin() {
      const user = getCurrentUser();
      if (!user || user.username !== ADMIN_USERNAME) {
        adminGuestLock.classList.remove("hidden");
        adminContent.classList.add("hidden");
      } else {
        adminGuestLock.classList.add("hidden");
        adminContent.classList.remove("hidden");
      }
    }

    function renderChat() {
      chatBox.innerHTML = "";
      db.chat.forEach(msg => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${msg.from}:</strong> ${msg.text}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function renderNotifications() {
      notifList.innerHTML = "";
      db.notifications.forEach(n => {
        const div = document.createElement("div");
        div.className = "notif-entry";
        div.textContent = n.text;
        notifList.appendChild(div);
      });
      const count = db.notifications.length;
      if (count > 0) {
        notifCount.textContent = count;
        notifCount.classList.remove("hidden");
      } else {
        notifCount.classList.add("hidden");
      }
    }

    function renderAll() {
      renderAuth();
      renderStats();
      renderFriends();
      renderHome();
      renderCatalog();
      renderCreate();
      renderProfile();
      renderTrades();
      renderAdmin();
      renderChat();
      renderNotifications();
    }

    loginBtn.addEventListener("click", () => {
      const u = authUsername.value.trim();
      const p = authPassword.value;
      if (!u || !p) {
        authMessage.textContent = "Enter username and password.";
        return;
      }
      const user = db.users[u];
      if (!user || user.password !== p) {
        authMessage.textContent = "Invalid credentials.";
        return;
      }
      db.currentUser = u;
      authMessage.textContent = "";
      saveData();
      addNotification(`Logged in as ${u}.`);
      renderAll();
    });

    signupBtn.addEventListener("click", () => {
      const u = authUsername.value.trim();
      const p = authPassword.value;
      if (!u || !p) {
        authMessage.textContent = "Enter username and password.";
        return;
      }
      if (db.users[u]) {
        authMessage.textContent = "Username already taken.";
        return;
      }
      db.users[u] = {
        username: u,
        password: p,
        currency: 1000,
        inventory: [],
        friends: [],
        createdAt: Date.now()
      };
      db.currentUser = u;
      authMessage.textContent = "";
      saveData();
      addNotification(`Welcome, ${u}! You received 1,000 RES.`);
      renderAll();
    });

    logoutBtn.addEventListener("click", () => {
      db.currentUser = null;
      saveData();
      renderAll();
    });

    authBtn.addEventListener("click", () => {
      showView("homeView");
    });

    themeToggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
    });

    createItemBtn.addEventListener("click", () => {
      const user = getCurrentUser();
      if (!user) return;
      const name = createName.value.trim();
      const type = createType.value;
      const price = parseInt(createPrice.value, 10) || 0;
      const value = parseInt(createValue.value, 10) || 0;
      if (!name) {
        createMessage.textContent = "Enter a name.";
        return;
      }
      const id = db.nextItemId++;
      db.items[id] = {
        id,
        name,
        type,
        price,
        value,
        creator: user.username
      };
      saveData();
      createMessage.textContent = `Created item #${id} (${name}).`;
      createName.value = "";
      renderAll();
    });

    inventoryFilter.addEventListener("change", renderProfile);
    catalogSort.addEventListener("change", renderCatalog);
    catalogFilter.addEventListener("change", renderCatalog);

    openTradeWindowBtn.addEventListener("click", () => {
      const user = getCurrentUser();
      if (!user) return;
      const targetName = tradeTargetUser.value.trim();
      if (!targetName) {
        tradeMessage.textContent = "Enter a username to trade with.";
        return;
      }
      if (!db.users[targetName]) {
        tradeMessage.textContent = "User not found.";
        return;
      }
      if (targetName === user.username) {
        tradeMessage.textContent = "You cannot trade with yourself.";
        return;
      }
      currentTradeTarget = targetName;
      currentOfferIds = [];
      currentRequestIds = [];
      tradeOfferBuxInput.value = 0;
      tradeRequestBuxInput.value = 0;
      tradeWindow.classList.remove("hidden");
      tradeMessage.textContent = "";
      renderTradeWindowLists();
    });

    closeTradeWindowBtn.addEventListener("click", () => {
      tradeWindow.classList.add("hidden");
      currentTradeTarget = null;
    });

    tradeOfferAddBtn.addEventListener("click", () => {
      const id = parseInt(tradeOfferAddSelect.value, 10);
      if (!id) return;
      if (!currentOfferIds.includes(id)) currentOfferIds.push(id);
      renderTradeWindowLists();
    });

    tradeRequestAddBtn.addEventListener("click", () => {
      const id = parseInt(tradeRequestAddSelect.value, 10);
      if (!id) return;
      if (!currentRequestIds.includes(id)) currentRequestIds.push(id);
      renderTradeWindowLists();
    });

    tradeOfferBuxInput.addEventListener("input", renderTradeWindowLists);
    tradeRequestBuxInput.addEventListener("input", renderTradeWindowLists);

    createTradeBtn.addEventListener("click", () => {
      const user = getCurrentUser();
      if (!user || !currentTradeTarget) return;
      const toUser = currentTradeTarget;
      const target = db.users[toUser];
      if (!target) return;

      const offerBux = parseInt(tradeOfferBuxInput.value, 10) || 0;
      const requestBux = parseInt(tradeRequestBuxInput.value, 10) || 0;

      if (offerBux < 0 || requestBux < 0) {
        tradeMessage.textContent = "RES Bux cannot be negative.";
        tradeMessage.className = "error";
        return;
      }
      if (offerBux > user.currency) {
        tradeMessage.textContent = "You do not have enough RES Bux.";
        tradeMessage.className = "error";
        return;
      }

      const trade = {
        id: Date.now() + Math.random(),
        from: user.username,
        to: toUser,
        offerItemIds: [...currentOfferIds],
        requestItemIds: [...currentRequestIds],
        offerBux,
        requestBux,
        createdAt: Date.now(),
        status: "pending"
      };
      db.trades.push(trade);
      saveData();
      addNotification(`Trade sent to ${toUser}.`);
      tradeMessage.textContent = "Trade sent.";
      tradeMessage.className = "success";
      tradeWindow.classList.add("hidden");
      currentTradeTarget = null;
      renderAll();
    });

    adminGiveBtn.addEventListener("click", () => {
      const user = getCurrentUser();
      if (!user || user.username !== ADMIN_USERNAME) return;
      const targetName = adminGiveUser.value.trim();
      const amt = parseInt(adminGiveAmount.value, 10) || 0;
      const target = db.users[targetName];
      if (!target) {
        adminMessage.textContent = "User not found.";
        return;
      }
      target.currency += amt;
      saveData();
      adminMessage.textContent = `Gave ${formatRes(amt)} to ${targetName}.`;
      renderAll();
    });

    adminDeleteItemBtn.addEventListener("click", () => {
      const user = getCurrentUser();
      if (!user || user.username !== ADMIN_USERNAME) return;
      const id = parseInt(adminDeleteItemId.value, 10);
      if (!db.items[id]) {
        adminMessage.textContent = "Item not found.";
        return;
      }
      if (!confirm("Are you sure you want to delete this item?")) return;
      delete db.items[id];
      Object.values(db.users).forEach(u => {
        u.inventory = (u.inventory || []).filter(x => x !== id);
      });
      saveData();
      adminMessage.textContent = `Deleted item #${id}.`;
      renderAll();
    });

    chatSendBtn.addEventListener("click", () => {
      const user = getCurrentUser();
      const text = chatInput.value.trim();
      if (!text) return;
      const from = user ? user.username : "Guest";
      addChatMessage(from, text);
      chatInput.value = "";
    });

    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter") chatSendBtn.click();
    });

    notifBell.addEventListener("click", () => {
      db.notifications = [];
      saveData();
      renderNotifications();
    });

    globalSearchInput.addEventListener("keydown", e => {
      if (e.key !== "Enter") return;
      const q = globalSearchInput.value.trim().toLowerCase();
      if (!q) return;
      const userMatch = Object.values(db.users).find(u => u.username.toLowerCase() === q);
      if (userMatch) {
        showView("profileView");
        db.currentUser = userMatch.username;
        saveData();
        renderAll();
        return;
      }
      const itemMatch = Object.values(db.items).find(i => i.name.toLowerCase().includes(q));
      if (itemMatch) {
        showView("catalogView");
        renderCatalog();
        addNotification(`Found item: ${itemMatch.name}`);
        return;
      }
      addNotification("No user or item found for that search.");
    });

    loadData();
    ensureDemoData();
    renderAll();
  </script>
</body>
</html>
